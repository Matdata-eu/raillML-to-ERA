PREFIX era: <http://data.europa.eu/949/>
PREFIX country: <http://publications.europa.eu/resource/authority/country/>
PREFIX gsp: <http://www.opengis.net/ont/geosparql#>
PREFIX railml: <https://www.railml.org/schemas/3.2#>
PREFIX xyz: <http://sparql.xyz/facade-x/data/>
PREFIX fx: <http://sparql.xyz/facade-x/ns/>
PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>

# Phase 3.3 — Platform Edges (functional infrastructure)
# Maps railml:platformEdge → era:PlatformEdge
#
# Source: 13 railML platform edge instances
#  
# Target properties:
#   - era:platformId — platform name (from belongsToPlatform reference)
#   - rdfs:label — platform edge name (if available)
#   - era:platformHeight — reference to ERA platform height concept (IRI)
#     → Converts railML @height (meters) to ERA concept URI (millimeters)
#     → Maps to http://data.europa.eu/949/concepts/platform-heights/{notation}
#   - era:infrastructureManager — OrganisationRole
#     → For workshop: all platform edges assigned to organisations/0076_IM (Belgian IM)
#   - era:netReference — NetLinearReference for linear extent positioning
#   - gsp:hasGeometry — Geometry resource with screen visualization coordinates
#
# NetLinearReference structure (ERA standard - multi-element sequence):
#   - era:hasSequence → RDF List of LinearElements (all segments in order)
#   - era:startsAt → NetPointReference (start of FIRST segment)
#   - era:endsAt → NetPointReference (end of LAST segment)
#
# RDF List structure:
#   - First segment: rdf:first → LinearElement, rdf:rest → second list node
#   - Intermediate segments: rdf:first → LinearElement, rdf:rest → next list node
#   - Last segment: rdf:first → LinearElement, rdf:rest → rdf:nil
#
# NetPointReference structure (for overall extent start/end):
#   - era:hasTopoCoordinate → TopologicalCoordinate
#   - era:hasLrsCoordinate → LinearPositioningSystemCoordinate
#
# LinearPositioningSystemCoordinate structure:
#   - era:kmPost → KilometricPost (reference to km post)
#   - era:offsetFromKilometricPost → offset in meters (xsd:double)
#
# KilometricPost structure:
#   - era:hasLRS → LinearPositioningSystem (reference to positioning system)
#   - era:kilometer → km number (xsd:double)
#
# TopologicalCoordinate structure:
#   - era:onLinearElement → reference to micro-level LinearElement
#   - era:offsetFromOrigin → position on element (xsd:integer, rounded)
#
# Platform edge linear extent pattern (ERA standard):
#   Each railML platformEdge has linearLocation with associatedNetElement entries.
#   All segments are aggregated into ONE NetLinearReference with multi-element hasSequence RDF List.
#   Unlike tracks (which typically have multiple segments), most platform edges
#   span a single netElement, but the pattern handles both cases.
#
# URI Patterns:
#   PlatformEdge: http://data.europa.eu/949/functionalInfrastructure/platformEdges/{id}
#   Geometry: http://data.europa.eu/949/functionalInfrastructure/platformEdges/{id}/geometry
#   NetLinearReference: http://data.europa.eu/949/topology/netLinearReferences/{platformEdgeId} (ONE per platform edge)
#   RDF List nodes: http://data.europa.eu/949/topology/netLinearReferences/{platformEdgeId}_hasSequence_list_{sequence}
#   NetPointReference (start): http://data.europa.eu/949/topology/netPointReferences/{platformEdgeId}_start
#   NetPointReference (end): http://data.europa.eu/949/topology/netPointReferences/{platformEdgeId}_end
#   TopologicalCoordinate (start): http://data.europa.eu/949/topology/topologicalCoordinates/{platformEdgeId}_start_{firstNetElementId}_{firstPosBegin}
#   TopologicalCoordinate (end): http://data.europa.eu/949/topology/topologicalCoordinates/{platformEdgeId}_end_{lastNetElementId}_{lastPosEnd}
#   LinearPositioningSystemCoordinate (start): http://data.europa.eu/949/topology/linearPositioningSystemCoordinates/{platformEdgeId}_start_{positioningSystemRef}_{firstMeasure}
#   LinearPositioningSystemCoordinate (end): http://data.europa.eu/949/topology/linearPositioningSystemCoordinates/{platformEdgeId}_end_{positioningSystemRef}_{lastMeasure}
#   KilometricPost: http://data.europa.eu/949/kilometricPosts/{positioningSystemRef}_km_{kmNumber}
#   OrganisationRole: http://data.europa.eu/949/organisations/0076_IM (hardcoded for workshop demo)

CONSTRUCT {
  # Platform Edge resource
  ?eraPlatformEdge a era:PlatformEdge ;
                   era:platformId ?finalPlatformId ;
                   rdfs:label ?platformEdgeName , ?platformEdgeNameEn ;
                   era:platformHeight ?platformHeightConcept ;
                   era:inCountry country:NOR ;
                   era:infrastructureManager <http://data.europa.eu/949/organisations/0076_IM> ;
                   era:netReference ?netLinearRef ;
                   gsp:hasGeometry ?geometry .

  # Geometry (screen visualization)
  ?geometry a gsp:Geometry ;
            gsp:asWKT ?wkt .
}
WHERE {
  # Get all platform edges
  ?platformEdge a railml:platformEdge ;
                xyz:id ?platformEdgeId .

  # Mint ERA PlatformEdge URI
  BIND (IRI(CONCAT("http://data.europa.eu/949/functionalInfrastructure/platformEdges/", ?platformEdgeId)) AS ?eraPlatformEdge)

  # Mint Geometry URI
  BIND (IRI(CONCAT("http://data.europa.eu/949/functionalInfrastructure/platformEdges/", ?platformEdgeId, "/geometry")) AS ?geometry)

  # Get platform height and map to ERA concept
  # railML @height is in meters, ERA expects reference to concept in millimeters
  OPTIONAL {
    ?platformEdge xyz:height ?heightMeters .
    
    # Convert to millimeters
    BIND (FLOOR(STRDT(?heightMeters, xsd:decimal) * 1000) AS ?heightMm)
    
    # Map to ERA platform height concept URI based on millimeter value
    # Standard heights: 550mm → /30, 760mm → /40
    BIND (
      IF(?heightMm = 550, IRI("http://data.europa.eu/949/concepts/platform-heights/30"),
      IF(?heightMm = 760, IRI("http://data.europa.eu/949/concepts/platform-heights/40"),
      IF(?heightMm = 920, IRI("http://data.europa.eu/949/concepts/platform-heights/140"),
         CONCAT("Mapping error, platform height from source: ", STR(?heightMm))
      ))) AS ?platformHeightConcept
    )
  }

  # Get platform edge name (optional)
  OPTIONAL {
    ?platformEdge fx:name ?nameNode .
    ?nameNode xyz:name ?nameValue .
    OPTIONAL {
      ?nameNode xyz:language ?lang
    }
    BIND (IF(BOUND(?lang),STRLANG(?nameValue,?lang),?nameValue) AS ?platformEdgeName)
    BIND (IF(BOUND(?lang),STRLANG(?nameValue,"en"),?nameValue) AS ?platformEdgeNameEn) # need an English name
  }

  # Get platform name via belongsToPlatform relationship (optional)
  OPTIONAL {
    ?platformEdge xyz:belongsToPlatform ?platformRef .
    ?platform a railml:platform ;
              xyz:id ?platformRef .
    ?platform fx:name ?platformNameNode .
    ?platformNameNode xyz:name ?platformName .
  }
  BIND (COALESCE(STR(?platformName), STR(?platformEdgeName), "Missing") AS ?finalPlatformId)

  # Get screen visualization geometry (optional)
  OPTIONAL {
    # Find linearElementProjection for this platform edge
    ?visualization a railml:infrastructureVisualization .
    ?visualization fx:linearElementProjection ?projection .
    ?projection xyz:refersToElement ?platformEdgeId .
    
    # Aggregate all coordinates into WKT LineString format
    {
      SELECT ?platformEdgeId (CONCAT("LINESTRING(", GROUP_CONCAT(?coordPair; separator=", "), ")") AS ?wktString)
      WHERE {
        ?viz a railml:infrastructureVisualization .
        ?viz fx:linearElementProjection ?proj .
        ?proj xyz:refersToElement ?platformEdgeId ;
              fx:coordinate ?coord .
        ?coord xyz:x ?x ;
               xyz:y ?y .
        
        # Build coordinate pair "x y"
        BIND (CONCAT(STR(?x), " ", STR(?y)) AS ?coordPair)
      }
      GROUP BY ?platformEdgeId
    }
    
    # Convert to WKT literal with proper datatype
    BIND (STRDT(?wktString, gsp:wktLiteral) AS ?wkt)
  }

  # Get linear location with associated net elements
  ?platformEdge fx:linearLocation ?linearLoc .
  ?linearLoc fx:associatedNetElement ?assocNode .
  
  # Get net element reference and positions
  ?assocNode xyz:netElementRef ?netElementRef ;
             xyz:posBegin ?posBegin ;
             xyz:posEnd ?posEnd .
  
  # Get sequence (for ordering segments, use 1 as default if not present)
  OPTIONAL { ?assocNode xyz:sequence ?seqValue . }
  BIND (COALESCE(?seqValue, "1") AS ?sequenceStr)
  BIND (xsd:integer(?sequenceStr) AS ?sequence)
  
  # Calculate max sequence for this platform edge (for RDF List termination)
  {
    SELECT ?platformEdgeId (MAX(?seq) AS ?maxSequence)
    WHERE {
      ?pe a railml:platformEdge ;
         xyz:id ?platformEdgeId ;
         fx:linearLocation/fx:associatedNetElement ?an .
      OPTIONAL {
        ?an xyz:sequence ?seq_opt .
      }
      BIND (xsd:integer(COALESCE(?seq_opt, "1")) AS ?seq)
    }
    GROUP BY ?platformEdgeId
  }
  
  # Calculate min sequence for this platform edge (for start point detection)
  {
    SELECT ?platformEdgeId (MIN(?seq) AS ?minSequence)
    WHERE {
      ?pe a railml:platformEdge ;
         xyz:id ?platformEdgeId ;
         fx:linearLocation/fx:associatedNetElement ?an .
      OPTIONAL {
        ?an xyz:sequence ?seq_opt .
      }
      BIND (xsd:integer(COALESCE(?seq_opt, "1")) AS ?seq)
    }
    GROUP BY ?platformEdgeId
  }
  
  # Convert positions to integer (round to nearest meter)
  BIND (xsd:integer(ROUND(xsd:double(?posBegin))) AS ?posBeginInteger)
  BIND (xsd:integer(ROUND(xsd:double(?posEnd))) AS ?posEndInteger)
  
  # Dereference netElement to get LinearElement URI
  ?netElement a railml:netElement ;
              xyz:id ?netElementRef .
  BIND (IRI(CONCAT("http://data.europa.eu/949/topology/netElements/", ?netElementRef)) AS ?eraLinearElement)

  # Mint NetLinearReference URI (ONE per platform edge, no segment suffix)
  BIND (IRI(CONCAT("http://data.europa.eu/949/topology/netLinearReferences/", ?platformEdgeId)) AS ?netLinearRef)

  # Mint RDF List node URI for this segment
  BIND (IRI(CONCAT("http://data.europa.eu/949/topology/netLinearReferences/", ?platformEdgeId, "_hasSequence_list_", STR(?sequence))) AS ?sequenceListNode)
  
  # Mint next RDF List node URI (for rdf:rest)
  BIND (IRI(CONCAT("http://data.europa.eu/949/topology/netLinearReferences/", ?platformEdgeId, "_hasSequence_list_", STR(?sequence + 1))) AS ?nextListNodeTemp)
  
  # Determine rdf:rest value: rdf:nil for last segment, next list node otherwise
  BIND (IF(?sequence = ?maxSequence, rdf:nil, ?nextListNodeTemp) AS ?nextListNode)

  # Conditionally mint first list node URI (only for minSequence to create era:hasSequence)
  BIND (IF(?sequence = ?minSequence, ?sequenceListNode, ?UNDEF) AS ?firstSequenceListNode)

  # Get LRS coordinates for start/end points
  ?assocNode fx:linearCoordinateBegin ?startLinCoord .
  ?startLinCoord xyz:measure ?startMeasure ;
                 xyz:positioningSystemRef ?posSystemRef .
  
  BIND (xsd:double(?startMeasure) AS ?startMeasureDouble)
  
  ?assocNode fx:linearCoordinateEnd ?endLinCoord .
  ?endLinCoord xyz:measure ?endMeasure ;
               xyz:positioningSystemRef ?posSystemRef .  # Same positioning system as start
  
  BIND (xsd:double(?endMeasure) AS ?endMeasureDouble)
  
  # Dereference LinearPositioningSystem
  ?lps a railml:linearPositioningSystem ;
       xyz:id ?posSystemRef .
  BIND (IRI(CONCAT("http://data.europa.eu/949/linearPositioningSystems/", ?posSystemRef)) AS ?eraLPS)

  # ===== START POINT (ONLY for first segment, sequence = minSequence) =====
  
  # Conditionally mint start point NetPointReference URI (only for min sequence)
  BIND (IF(?sequence = ?minSequence,
    IRI(CONCAT("http://data.europa.eu/949/topology/netPointReferences/", ?platformEdgeId, "_start")),
    ?UNDEF) AS ?startPointRef)
  
  # Conditionally mint start TopologicalCoordinate URI
  BIND (IF(?sequence = ?minSequence,
    IRI(CONCAT("http://data.europa.eu/949/topology/topologicalCoordinates/", ?platformEdgeId, "_start_", ?netElementRef, "_", STR(?posBegin))),
    ?UNDEF) AS ?startTopoCoord)
  
  # Calculate start KilometricPost (for min sequence)
  BIND (IF(?sequence = ?minSequence, xsd:double(FLOOR(?startMeasureDouble / 1000.0)), ?UNDEF) AS ?startKmNumber)
  BIND (IF(?sequence = ?minSequence,
    IRI(CONCAT("http://data.europa.eu/949/kilometricPosts/", ?posSystemRef, "_km_", STR(?startKmNumber))),
    ?UNDEF) AS ?startKmPost)
  
  # Calculate start offset from km post
  BIND (IF(?sequence = ?minSequence, ?startMeasureDouble - (?startKmNumber * 1000.0), ?UNDEF) AS ?startKmOffset)
  
  # Mint start LinearPositioningSystemCoordinate URI
  BIND (IF(?sequence = ?minSequence,
    IRI(CONCAT("http://data.europa.eu/949/topology/linearPositioningSystemCoordinates/", ?platformEdgeId, "_start_", ?posSystemRef, "_", STR(?startMeasure))),
    ?UNDEF) AS ?startLrsCoord)

  # ===== END POINT (ONLY for last segment, sequence = maxSequence) =====
  
  # Conditionally mint end point NetPointReference URI (only for max sequence)
  BIND (IF(?sequence = ?maxSequence,
    IRI(CONCAT("http://data.europa.eu/949/topology/netPointReferences/", ?platformEdgeId, "_end")),
    ?UNDEF) AS ?endPointRef)
  
  # Conditionally mint end TopologicalCoordinate URI
  BIND (IF(?sequence = ?maxSequence,
    IRI(CONCAT("http://data.europa.eu/949/topology/topologicalCoordinates/", ?platformEdgeId, "_end_", ?netElementRef, "_", STR(?posEnd))),
    ?UNDEF) AS ?endTopoCoord)
  
  # Calculate end KilometricPost (for max sequence)
  BIND (IF(?sequence = ?maxSequence, xsd:double(FLOOR(?endMeasureDouble / 1000.0)), ?UNDEF) AS ?endKmNumber)
  BIND (IF(?sequence = ?maxSequence,
    IRI(CONCAT("http://data.europa.eu/949/kilometricPosts/", ?posSystemRef, "_km_", STR(?endKmNumber))),
    ?UNDEF) AS ?endKmPost)
  
  # Calculate end offset from km post
  BIND (IF(?sequence = ?maxSequence, ?endMeasureDouble - (?endKmNumber * 1000.0), ?UNDEF) AS ?endKmOffset)
  
  # Mint end LinearPositioningSystemCoordinate URI
  BIND (IF(?sequence = ?maxSequence,
    IRI(CONCAT("http://data.europa.eu/949/topology/linearPositioningSystemCoordinates/", ?platformEdgeId, "_end_", ?posSystemRef, "_", STR(?endMeasure))),
    ?UNDEF) AS ?endLrsCoord)
}
ORDER BY ?platformEdgeId ?sequence
