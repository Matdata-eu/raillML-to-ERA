PREFIX era: <http://data.europa.eu/949/>
PREFIX country: <http://publications.europa.eu/resource/authority/country/>
PREFIX gsp: <http://www.opengis.net/ont/geosparql#>
PREFIX railml: <https://www.railml.org/schemas/3.2#>
PREFIX xyz: <http://sparql.xyz/facade-x/data/>
PREFIX fx: <http://sparql.xyz/facade-x/ns/>
PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>

# Phase 3.9 — Bridges (functional infrastructure)
# Maps railML underCrossing with constructionType="bridge" or "movableBridge" → era:Bridge
# Note: railML overCrossing with constructionType="bridge" is NOT an ERA element
#
# Source: railML underCrossing instances with constructionType="bridge" or "movableBridge"
#  
# Target: era:Bridge with properties:
#   - rdfs:label (bridge name from fx:name)
#   - era:inCountry → country:NOR (Norway country code)
#   - era:infrastructureManager (OrganisationRole)
#     → For workshop: all bridges assigned to organisations/0076_IM (Belgian IM)
#   - era:netReference (NetAreaReference for area coverage positioning)
#   - era:existBridgeWindRestriction → false (boolean, SHACL required)
#   - era:existOpeningHoursLimitation → false (boolean, SHACL required)
#
# NetAreaReference structure (area coverage with multiple segments):
#   - era:includes → RDF List of NetLinearReferences
#
# NetLinearReference structure (one per segment, linear extent not point):
#   - era:hasSequence → RDF List of LinearElements
#   - era:startsAt → NetPointReference (start of extent)
#   - era:endsAt → NetPointReference (end of extent)
#
# NetPointReference structure (for start/end points):
#   - era:hasTopoCoordinate → TopologicalCoordinate
#   - era:hasLrsCoordinate → LinearPositioningSystemCoordinate
#
# LinearPositioningSystemCoordinate structure:
#   - era:kmPost → KilometricPost (reference to km post)
#   - era:offsetFromKilometricPost → offset in meters (xsd:double)
#
# KilometricPost structure:
#   - era:hasLRS → LinearPositioningSystem (reference to positioning system)
#   - era:kilometer → km number (xsd:double)
#
# TopologicalCoordinate structure:
#   - era:onLinearElement → reference to micro-level LinearElement
#   - era:offsetFromOrigin → position on element (xsd:double)
#
# Bridge linear extent pattern:
#   Each railML bridge has areaLocation with multiple associatedNetElement entries.
#   Each associatedNetElement defines a segment of the bridge's linear extent:
#   - netElementRef: which LinearElement the segment is on
#   - posBegin, posEnd: start/end positions on that LinearElement
#   - linearCoordinateBegin/End: LRS coordinates for the segment
#   - sequence: ordering of segments
#
# URI Patterns:
#   Bridge: http://data.europa.eu/949/functionalInfrastructure/bridges/{id}
#   NetAreaReference: http://data.europa.eu/949/topology/netAreaReferences/{bridgeId}
#   NetLinearReference: http://data.europa.eu/949/topology/netLinearReferences/{bridgeId}_segment_{sequence}
#   NetPointReference (start): http://data.europa.eu/949/topology/netPointReferences/{bridgeId}_segment_{sequence}_start
#   NetPointReference (end): http://data.europa.eu/949/topology/netPointReferences/{bridgeId}_segment_{sequence}_end
#   TopologicalCoordinate: http://data.europa.eu/949/topology/topologicalCoordinates/{bridgeId}_{netElementId}_{position}
#   LinearPositioningSystemCoordinate: http://data.europa.eu/949/topology/linearPositioningSystemCoordinates/{bridgeId}_{segment}_{start_or_end}_{positioningSystemRef}_{measure}
#   KilometricPost: http://data.europa.eu/949/kilometricPosts/{positioningSystemRef}_km_{kmNumber}
#   OrganisationRole: http://data.europa.eu/949/organisations/0076_IM (hardcoded for workshop demo)

CONSTRUCT {
  # Bridge resource
  ?eraBridge a era:Bridge ;
             rdfs:label ?bridgeName , ?bridgeNameEn ;
             era:inCountry country:NOR ;
             era:infrastructureManager <http://data.europa.eu/949/organisations/0076_IM> ;
             era:netReference ?netAreaRef ;
             era:existBridgeWindRestriction false ;
             era:existOpeningHoursLimitation false .

  # NetAreaReference (one per bridge)
  ?netAreaRef a era:NetAreaReference ;
              era:includes ?includesList .

  # RDF List structure for includes (list of NetLinearReferences)
  ?includesList a rdf:List;
                rdf:first ?netLinearRef ;
                rdf:rest ?restList .

  # NetLinearReference (one per associatedNetElement segment)
  ?netLinearRef a era:NetLinearReference ;
                era:hasSequence ?sequenceList ;
                era:startsAt ?startPointRef ;
                era:endsAt ?endPointRef .

  # RDF List structure for hasSequence (single-element list)
  ?sequenceList a rdf:List;
                rdf:first ?eraLinearElement ;
                rdf:rest rdf:nil .

  # Start point NetPointReference
  ?startPointRef a era:NetPointReference ;
                 era:hasTopoCoordinate ?startTopoCoord ;
                 era:hasLrsCoordinate ?startLrsCoord .

  # Start TopologicalCoordinate
  ?startTopoCoord a era:TopologicalCoordinate ;
                  era:onLinearElement ?eraLinearElement ;
                  era:offsetFromOrigin ?posBeginInteger .
  
  # Start LinearPositioningSystemCoordinate
  ?startLrsCoord a era:LinearPositioningSystemCoordinate ;
                 era:kmPost ?startKmPost ;
                 era:offsetFromKilometricPost ?startKmOffset .
  
  # Start KilometricPost
  ?startKmPost a era:KilometricPost ;
               era:hasLRS ?eraLPS ;
               era:kilometer ?startKmNumber .

  # End point NetPointReference  
  ?endPointRef a era:NetPointReference ;
               era:hasTopoCoordinate ?endTopoCoord ;
               era:hasLrsCoordinate ?endLrsCoord .

  # End TopologicalCoordinate
  ?endTopoCoord a era:TopologicalCoordinate ;
                era:onLinearElement ?eraLinearElement ;
                era:offsetFromOrigin ?posEndInteger .
  
  # End LinearPositioningSystemCoordinate
  ?endLrsCoord a era:LinearPositioningSystemCoordinate ;
               era:kmPost ?endKmPost ;
               era:offsetFromKilometricPost ?endKmOffset .
  
  # End KilometricPost
  ?endKmPost a era:KilometricPost ;
             era:hasLRS ?eraLPS ;
             era:kilometer ?endKmNumber .
}
WHERE {
  # Get all bridges (underCrossing with constructionType="bridge" or "movableBridge")
  ?bridge a railml:underCrossing ;
          xyz:id ?bridgeId ;
          xyz:constructionType ?constructionType .
  FILTER (?constructionType IN ("bridge", "movableBridge"))

  # Get max sequence for this bridge (to determine last segment for rdf:nil)
  {
    SELECT ?bridgeId (MAX(xsd:integer(COALESCE(?seqVal, "1"))) AS ?maxSequence)
    WHERE {
      ?br a railml:underCrossing ;
          xyz:id ?bridgeId ;
          xyz:constructionType ?ct .
      FILTER (?ct IN ("bridge", "movableBridge"))
      ?br fx:areaLocation/fx:associatedNetElement ?an .
      OPTIONAL { ?an xyz:sequence ?seqVal . }
    }
    GROUP BY ?bridgeId
  }

  # Mint ERA Bridge URI
  BIND (IRI(CONCAT("http://data.europa.eu/949/functionalInfrastructure/bridges/", ?bridgeId)) AS ?eraBridge)

  # Mint NetAreaReference URI (one per bridge)
  BIND (IRI(CONCAT("http://data.europa.eu/949/topology/netAreaReferences/", ?bridgeId)) AS ?netAreaRef)

  # Get bridge name
  OPTIONAL {
    ?bridge fx:name ?nameNode .
    ?nameNode xyz:name ?nameValue .
    OPTIONAL {
      ?nameNode xyz:language ?lang
    }
    BIND (IF(BOUND(?lang),STRLANG(?nameValue,?lang),?nameValue) AS ?bridgeName)
    BIND (IF(BOUND(?lang),STRLANG(?nameValue,"en"),?nameValue) AS ?bridgeNameEn) # need an English name
  }

  # Get area location with associated net elements
  ?bridge fx:areaLocation ?areaLoc .
  ?areaLoc fx:associatedNetElement ?assocNode .
  
  # Get net element reference and positions
  ?assocNode xyz:netElementRef ?netElementRef ;
             xyz:posBegin ?posBegin ;
             xyz:posEnd ?posEnd .
  
  # Get sequence (for ordering segments), default to "1" if not present
  OPTIONAL { ?assocNode xyz:sequence ?seqValue . }
  BIND (COALESCE(?seqValue, "1") AS ?sequence)
  
  # Convert positions to integer (round to nearest meter)
  BIND (xsd:integer(ROUND(xsd:double(?posBegin))) AS ?posBeginInteger)
  BIND (xsd:integer(ROUND(xsd:double(?posEnd))) AS ?posEndInteger)
  
  # Dereference netElement to get LinearElement URI
  ?netElement a railml:netElement ;
              xyz:id ?netElementRef .
  BIND (IRI(CONCAT("http://data.europa.eu/949/topology/netElements/", ?netElementRef)) AS ?eraLinearElement)

  # Mint NetLinearReference URI
  BIND (IRI(CONCAT("http://data.europa.eu/949/topology/netLinearReferences/", ?bridgeId, "_segment_", STR(?sequence))) AS ?netLinearRef)

  # Mint includes list URI (for NetAreaReference)
  BIND (IRI(CONCAT("http://data.europa.eu/949/topology/netAreaReferences/", ?bridgeId, "_includes_", STR(?sequence))) AS ?includesList)

  # Build rest of list: rdf:nil if last segment, otherwise next segment's list node
  BIND (IF(?sequence = ?maxSequence, rdf:nil, IRI(CONCAT("http://data.europa.eu/949/topology/netAreaReferences/", ?bridgeId, "_includes_", STR(xsd:integer(?sequence) + 1)))) AS ?restList)

  # Mint sequence list URI (for hasSequence in NetLinearReference)
  BIND (IRI(CONCAT("http://data.europa.eu/949/topology/netLinearReferences/", ?bridgeId, "_segment_", STR(?sequence), "_seqlist")) AS ?sequenceList)

  # ===== START POINT =====
  
  # Mint start point NetPointReference URI
  BIND (IRI(CONCAT("http://data.europa.eu/949/topology/netPointReferences/", ?bridgeId, "_segment_", STR(?sequence), "_start")) AS ?startPointRef)
  
  # Mint start TopologicalCoordinate URI
  BIND (IRI(CONCAT("http://data.europa.eu/949/topology/topologicalCoordinates/", ?bridgeId, "_", ?netElementRef, "_", STR(?posBegin))) AS ?startTopoCoord)
  
  # ===== END POINT =====
  
  # Mint end point NetPointReference URI
  BIND (IRI(CONCAT("http://data.europa.eu/949/topology/netPointReferences/", ?bridgeId, "_segment_", STR(?sequence), "_end")) AS ?endPointRef)
  
  # Mint end TopologicalCoordinate URI
  BIND (IRI(CONCAT("http://data.europa.eu/949/topology/topologicalCoordinates/", ?bridgeId, "_", ?netElementRef, "_", STR(?posEnd))) AS ?endTopoCoord)
  
  
  # ===== Get start LRS coordinates  =====
    
  ?assocNode fx:linearCoordinateBegin ?startLinCoord .
  ?startLinCoord xyz:measure ?startMeasure ;
                  xyz:positioningSystemRef ?posSystemRef .
  
  BIND (xsd:double(?startMeasure) AS ?startMeasureDouble)
  
  # Dereference LinearPositioningSystem
  ?lps a railml:linearPositioningSystem ;
        xyz:id ?posSystemRef .
  BIND (IRI(CONCAT("http://data.europa.eu/949/linearPositioningSystems/", ?posSystemRef)) AS ?eraLPS)
  
  # Calculate start KilometricPost (round to nearest km)
  BIND (xsd:double(FLOOR(?startMeasureDouble / 1000.0)) AS ?startKmNumber)
  BIND (IRI(CONCAT("http://data.europa.eu/949/kilometricPosts/", ?posSystemRef, "_km_", STR(?startKmNumber))) AS ?startKmPost)
  
  # Calculate start offset from km post
  BIND (?startMeasureDouble - (?startKmNumber * 1000.0) AS ?startKmOffset)
  
  # Mint start LinearPositioningSystemCoordinate URI
  BIND (IRI(CONCAT("http://data.europa.eu/949/topology/linearPositioningSystemCoordinates/", ?bridgeId, "_segment_", STR(?sequence), "_start_", ?posSystemRef, "_", STR(?startMeasure))) AS ?startLrsCoord)


  # ===== Get end LRS coordinates  =====
  
  ?assocNode fx:linearCoordinateEnd ?endLinCoord .
  ?endLinCoord xyz:measure ?endMeasure ;
                xyz:positioningSystemRef ?posSystemRef .  # Same positioning system as start
  
  BIND (xsd:double(?endMeasure) AS ?endMeasureDouble)

  # Calculate end KilometricPost (round to nearest km)
  BIND (xsd:double(FLOOR(?endMeasureDouble / 1000.0)) AS ?endKmNumber)
  BIND (IRI(CONCAT("http://data.europa.eu/949/kilometricPosts/", ?posSystemRef, "_km_", STR(?endKmNumber))) AS ?endKmPost)
  
  # Calculate end offset from km post
  BIND (?endMeasureDouble - (?endKmNumber * 1000.0) AS ?endKmOffset)
  
  # Mint end LinearPositioningSystemCoordinate URI
  BIND (IRI(CONCAT("http://data.europa.eu/949/topology/linearPositioningSystemCoordinates/", ?bridgeId, "_segment_", STR(?sequence), "_end_", ?posSystemRef, "_", STR(?endMeasure))) AS ?endLrsCoord)

}
ORDER BY ?bridgeId ?sequence
