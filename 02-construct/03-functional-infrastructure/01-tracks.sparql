PREFIX era: <http://data.europa.eu/949/>
PREFIX country: <http://data.europa.eu/949/countries/>
PREFIX gsp: <http://www.opengis.net/ont/geosparql#>
PREFIX railml: <https://www.railml.org/schemas/3.2#>
PREFIX xyz: <http://sparql.xyz/facade-x/data/>
PREFIX fx: <http://sparql.xyz/facade-x/ns/>
PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>

# Phase 3.1 — Tracks (functional infrastructure)
# Maps railml:track → era:RunningTrack or era:Siding (subclasses of era:Track)
#
# Source: 36 railML track instances
#  
# Subclass mapping based on railML track type:
#   - mainTrack, secondaryTrack, connectingTrack → era:RunningTrack
#   - sidingTrack → era:Siding
#
# Target properties (SHACL-compliant):
#   - era:trackId (string identifier) — REQUIRED for RunningTrack
#   - era:sidingId (string identifier) — REQUIRED for Siding
#   - rdfs:label (track name from fx:name)
#   - era:infrastructureManager (OrganisationRole)
#     → For workshop: all tracks assigned to organisations/0076_IM (Belgian IM)
#   - era:netReference (NetLinearReference for linear extent positioning)
#   - era:linesideDistanceIndication (LinesideDistanceIndication) — REQUIRED for RunningTrack
#     → Dummy data: appearance=02 ("Left and right"), frequency=1000 meters
#   - era:wheelSetGauge (SKOS Concept) — nominal track gauge
#     → For workshop: all tracks use standard gauge (1435mm) = concepts/nominal-track-gauges/30
#   - era:gaugingProfile (SKOS Concept) — loading gauge profile (optional)
#     → Mapped from railML loadingGauge code via shared netElement references
#     → Mapping: GA→10, GB→20, GC→30, G1→40, GB1→70, GB2→80
#
# NetLinearReference structure (linear extent, not point):
#   - era:startsAt → NetPointReference (start of extent)
#   - era:endsAt → NetPointReference (end of extent)
#
# NetPointReference structure (for start/end points):
#   - era:hasTopoCoordinate → TopologicalCoordinate
#   - era:hasLrsCoordinate → LinearPositioningSystemCoordinate
#
# LinearPositioningSystemCoordinate structure:
#   - era:kmPost → KilometricPost (reference to km post)
#   - era:offsetFromKilometricPost → offset in meters (xsd:double)
#
# KilometricPost structure:
#   - era:hasLRS → LinearPositioningSystem (reference to positioning system)
#   - era:kilometer → km number (xsd:integer)
#
# TopologicalCoordinate structure:
#   - era:onLinearElement → reference to micro-level LinearElement
#   - era:offsetFromOrigin → position on element (xsd:double)
#
# Track linear extent pattern:
#   Each railML track has linearLocation with multiple associatedNetElement entries.
#   Each associatedNetElement defines a segment of the track's linear extent:
#   - netElementRef: which LinearElement the segment is on
#   - posBegin, posEnd: start/end positions on that LinearElement
#   - linearCoordinateBegin/End: LRS coordinates for the segment
#   - sequence: ordering of segments
#
# URI Patterns:
#   Track: http://data.europa.eu/949/functionalInfrastructure/tracks/{id}
#   LinesideDistanceIndication: http://data.europa.eu/949/topology/linesideDistanceIndications/{trackId}
#   NetLinearReference: http://data.europa.eu/949/topology/netLinearReferences/{trackId}_segment_{sequence}
#   NetPointReference (start): http://data.europa.eu/949/topology/netPointReferences/{trackId}_segment_{sequence}_start
#   NetPointReference (end): http://data.europa.eu/949/topology/netPointReferences/{trackId}_segment_{sequence}_end
#   TopologicalCoordinate: http://data.europa.eu/949/topology/topologicalCoordinates/{trackId}_{netElementId}_{position}
#   LinearPositioningSystemCoordinate: http://data.europa.eu/949/topology/linearPositioningSystemCoordinates/{trackId}_{segment}_{start_or_end}_{positioningSystemRef}_{measure}
#   KilometricPost: http://data.europa.eu/949/kilometricPosts/{positioningSystemRef}_km_{kmNumber}
#   OrganisationRole: http://data.europa.eu/949/organisations/0076_IM (hardcoded for workshop demo)

CONSTRUCT {
  # Track resource (with subclass)
  ?eraTrack a ?trackClass ;
            era:trackId ?runningTrackId ; 
            era:sidingId ?sidingTrackId ;
            rdfs:label ?trackName ;
            era:inCountry country:NOR ;
            era:infrastructureManager <http://data.europa.eu/949/organisations/0076_IM> ;
            era:netReference ?netLinearRef ;
            era:linesideDistanceIndication ?ldi ;
            era:wheelSetGauge <http://data.europa.eu/949/concepts/nominal-track-gauges/30> ;
            era:gaugingProfile ?gaugingProfileConcept .

  # LinesideDistanceIndication (dummy data for RunningTrack)
  ?ldi a era:LinesideDistanceIndication ;
       era:linesideDistanceIndicationAppearance <http://data.europa.eu/949/concepts/lineside-distance-indication-appearance/02> ;
       era:linesideDistanceIndicationPositioning <http://data.europa.eu/949/concepts/lineside-distance-indication-positioning/02> ;
       era:linesideDistanceIndicationFrequency 500 .

  # NetLinearReference (one per associatedNetElement segment)
  ?netLinearRef a era:NetLinearReference ;
                era:hasSequence ?sequenceList ;
                era:startsAt ?startPointRef ;
                era:endsAt ?endPointRef .

  # RDF List structure for hasSequence (single-element list)
  ?sequenceList rdf:first ?eraLinearElement ;
                rdf:rest rdf:nil .

  # Start point NetPointReference
  ?startPointRef a era:NetPointReference ;
                 era:hasTopoCoordinate ?startTopoCoord ;
                 era:hasLrsCoordinate ?startLrsCoord .

  # Start TopologicalCoordinate
  ?startTopoCoord a era:TopologicalCoordinate ;
                  era:onLinearElement ?eraLinearElement ;
                  era:offsetFromOrigin ?posBeginDouble .
  
  # Start LinearPositioningSystemCoordinate
  ?startLrsCoord a era:LinearPositioningSystemCoordinate ;
                 era:kmPost ?startKmPost ;
                 era:offsetFromKilometricPost ?startKmOffset .
  
  # Start KilometricPost
  ?startKmPost a era:KilometricPost ;
               era:hasLRS ?eraLPS ;
               era:kilometer ?startKmNumber .

  # End point NetPointReference  
  ?endPointRef a era:NetPointReference ;
               era:hasTopoCoordinate ?endTopoCoord ;
               era:hasLrsCoordinate ?endLrsCoord .

  # End TopologicalCoordinate
  ?endTopoCoord a era:TopologicalCoordinate ;
                era:onLinearElement ?eraLinearElement ;
                era:offsetFromOrigin ?posEndDouble .
  
  # End LinearPositioningSystemCoordinate
  ?endLrsCoord a era:LinearPositioningSystemCoordinate ;
               era:kmPost ?endKmPost ;
               era:offsetFromKilometricPost ?endKmOffset .
  
  # End KilometricPost
  ?endKmPost a era:KilometricPost ;
             era:hasLRS ?eraLPS ;
             era:kilometer ?endKmNumber .
}
WHERE {
  # Get all tracks
  ?track a railml:track ;
         xyz:id ?trackId ;
         xyz:type ?trackType .

  # Determine track subclass based on railML type
  # mainTrack, secondaryTrack, connectingTrack → RunningTrack
  # sidingTrack → Siding
  BIND (
    IF(?trackType IN ("mainTrack", "secondaryTrack", "connectingTrack"),
      era:RunningTrack,
      era:Siding
    ) AS ?trackClass
  )

  # Mint ERA Track URI
  BIND (IRI(CONCAT("http://data.europa.eu/949/functionalInfrastructure/tracks/", ?trackId)) AS ?eraTrack)

  # Conditionally assign trackId or sidingId based on track subclass
  BIND (IF(?trackClass = era:RunningTrack, ?trackId, ?UNDEF) AS ?runningTrackId)
  BIND (IF(?trackClass = era:Siding, ?trackId, ?UNDEF) AS ?sidingTrackId)

  # Mint LinesideDistanceIndication URI (for RunningTrack only)
  BIND (
    IF(?trackType IN ("mainTrack", "secondaryTrack", "connectingTrack"),
      IRI(CONCAT("http://data.europa.eu/949/topology/linesideDistanceIndications/", ?trackId)),
      ?UNDEF
    ) AS ?ldi
  )

  # Get track name (optional)
  OPTIONAL {
    ?track fx:name ?nameNode .
    ?nameNode xyz:name ?trackName .
  }

  # Get loading gauge via shared netElement references (optional)
  # Tracks and loading gauges are linked via common netElementRef values
  OPTIONAL {
    # Get netElement reference from track's linear location
    ?track fx:linearLocation/fx:associatedNetElement ?trackAssoc .
    ?trackAssoc xyz:netElementRef ?sharedNetElementRef .
    
    # Find loading gauge with same netElement reference
    ?loadingGauge a railml:loadingGauge ;
                  xyz:code ?gaugeCode ;
                  fx:linearLocation/fx:associatedNetElement ?gaugeAssoc .
    ?gaugeAssoc xyz:netElementRef ?sharedNetElementRef .
  }
  
  # Map railML loading gauge code to ERA gauging profile SKOS concept
  BIND(
    IF(?gaugeCode = "GA", <http://data.europa.eu/949/concepts/gaugings/10>,
    IF(?gaugeCode = "GB", <http://data.europa.eu/949/concepts/gaugings/20>,
    IF(?gaugeCode = "GC", <http://data.europa.eu/949/concepts/gaugings/30>,
    IF(?gaugeCode = "G1", <http://data.europa.eu/949/concepts/gaugings/40>,
    IF(?gaugeCode = "GB1", <http://data.europa.eu/949/concepts/gaugings/70>,
    IF(?gaugeCode = "GB2", <http://data.europa.eu/949/concepts/gaugings/80>,
    ?UNDEF))))))
    AS ?gaugingProfileConcept
  )

  # Get linear location with associated net elements
  ?track fx:linearLocation ?linearLoc .
  ?linearLoc fx:associatedNetElement ?assocNode .
  
  # Get net element reference and positions
  ?assocNode xyz:netElementRef ?netElementRef ;
             xyz:posBegin ?posBegin ;
             xyz:posEnd ?posEnd .
  
  # Get sequence (for ordering segments)
  ?assocNode xyz:sequence ?sequence .
  
  # Convert positions to double
  BIND (xsd:double(?posBegin) AS ?posBeginDouble)
  BIND (xsd:double(?posEnd) AS ?posEndDouble)
  
  # Dereference netElement to get LinearElement URI
  ?netElement a railml:netElement ;
              xyz:id ?netElementRef .
  BIND (IRI(CONCAT("http://data.europa.eu/949/topology/netElements/", ?netElementRef)) AS ?eraLinearElement)

  # Mint NetLinearReference URI
  BIND (IRI(CONCAT("http://data.europa.eu/949/topology/netLinearReferences/", ?trackId, "_segment_", STR(?sequence))) AS ?netLinearRef)

  # Mint sequence list URI
  BIND (IRI(CONCAT("http://data.europa.eu/949/topology/netLinearReferences/", ?trackId, "_segment_", STR(?sequence), "_seqlist")) AS ?sequenceList)

  # ===== START POINT =====
  
  # Mint start point NetPointReference URI
  BIND (IRI(CONCAT("http://data.europa.eu/949/topology/netPointReferences/", ?trackId, "_segment_", STR(?sequence), "_start")) AS ?startPointRef)
  
  # Mint start TopologicalCoordinate URI
  BIND (IRI(CONCAT("http://data.europa.eu/949/topology/topologicalCoordinates/", ?trackId, "_", ?netElementRef, "_", STR(?posBegin))) AS ?startTopoCoord)
  
  # Get start LRS coordinates
  ?assocNode fx:linearCoordinateBegin ?startLinCoord .
  ?startLinCoord xyz:measure ?startMeasure ;
                 xyz:positioningSystemRef ?posSystemRef .
  
  BIND (xsd:double(?startMeasure) AS ?startMeasureDouble)
  
  # Get end LRS coordinates
  ?assocNode fx:linearCoordinateEnd ?endLinCoord .
  ?endLinCoord xyz:measure ?endMeasure ;
               xyz:positioningSystemRef ?posSystemRef .  # Same positioning system as start
  
  BIND (xsd:double(?endMeasure) AS ?endMeasureDouble)
  
  # Dereference LinearPositioningSystem
  ?lps a railml:linearPositioningSystem ;
       xyz:id ?posSystemRef .
  BIND (IRI(CONCAT("http://data.europa.eu/949/linearPositioningSystems/", ?posSystemRef)) AS ?eraLPS)
  
  # Calculate start KilometricPost (round to nearest km)
  BIND (xsd:integer(ROUND(?startMeasureDouble / 1000.0)) AS ?startKmNumber)
  BIND (IRI(CONCAT("http://data.europa.eu/949/kilometricPosts/", ?posSystemRef, "_km_", STR(?startKmNumber))) AS ?startKmPost)
  
  # Calculate start offset from km post
  BIND (?startMeasureDouble - (?startKmNumber * 1000.0) AS ?startKmOffset)
  
  # Mint start LinearPositioningSystemCoordinate URI
  BIND (IRI(CONCAT("http://data.europa.eu/949/topology/linearPositioningSystemCoordinates/", ?trackId, "_segment_", STR(?sequence), "_start_", ?posSystemRef, "_", STR(?startMeasure))) AS ?startLrsCoord)

  # ===== END POINT =====
  
  # Mint end point NetPointReference URI
  BIND (IRI(CONCAT("http://data.europa.eu/949/topology/netPointReferences/", ?trackId, "_segment_", STR(?sequence), "_end")) AS ?endPointRef)
  
  # Mint end TopologicalCoordinate URI
  BIND (IRI(CONCAT("http://data.europa.eu/949/topology/topologicalCoordinates/", ?trackId, "_", ?netElementRef, "_", STR(?posEnd))) AS ?endTopoCoord)
  
  # Calculate end KilometricPost (round to nearest km)
  BIND (xsd:integer(ROUND(?endMeasureDouble / 1000.0)) AS ?endKmNumber)
  BIND (IRI(CONCAT("http://data.europa.eu/949/kilometricPosts/", ?posSystemRef, "_km_", STR(?endKmNumber))) AS ?endKmPost)
  
  # Calculate end offset from km post
  BIND (?endMeasureDouble - (?endKmNumber * 1000.0) AS ?endKmOffset)
  
  # Mint end LinearPositioningSystemCoordinate URI
  BIND (IRI(CONCAT("http://data.europa.eu/949/topology/linearPositioningSystemCoordinates/", ?trackId, "_segment_", STR(?sequence), "_end_", ?posSystemRef, "_", STR(?endMeasure))) AS ?endLrsCoord)
}
ORDER BY ?trackId ?sequence
